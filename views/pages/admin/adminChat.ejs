<%- include('../../partials/admin-nav') %>

<body class="h-100" style="background-color: #f8f8f8;">
    <div class="mb-5 secondHead-admin" style="height: fit-content;">
        <div class="secondHead-content">
            <h1>แชท</h1>
        </div>
    </div>
    <div class="d-flex justify-content-between" style="margin-left: 240px; padding-left: 3em; width: 1370px;">
        <div class="chat-list pt-5 mt-5">
            <!-- รายชื่อ user -->
            <div class="mt-5" id="userlist">
                <div class="mb-3" style="width: 320px;">
                    <input type="text" class="form-control bg-white shadow-2-strong" id="searchChat" placeholder="ค้นหา"
                        aria-label="search" aria-describedby="basic-addon1">
                </div>
                <div id="getUserChatBox">
                    <% const userList = []; %>
                    <% users.forEach((user) => { %>
                    <div class="user-box" id="userbox<%= user.user_id %>" data-user="<%= user.user_id %>">
                        <div class="card-body d-flex h-100 ">
                            <div class="col-2 m-2 align-self-center chat-pf border">
                                <img src="<%= user.picture %>" alt="user-profile" draggable="false">
                            </div>
                            <div class="col mt-3 row justify-content-between">
                                <div class="col-5 overflow-hidden">
                                    <span class="fs-5 username"><%= user.username %></span><br>
                                    <small class="text-secondary text-truncate" id="current-ms-<%= user.user_id %>">
                                        <% const msg =  messages.filter(row => row.sender_id == user.user_id || row.recipient_id == user.user_id);%>
                                        <% if (msg.length > 0) { %>
                                        <%= msg[0].message %>
                                        <% } %>
                                    </small>
                                </div>
                                <div class="col-5 m-1 pe-3">
                                    <small
                                        class="align-self-center text-secondary"><%= timeAgo(msg[0].created_at) %></small><br>
                                    <small class="nonti w-100 d-flex justify-content-end">
                                        <% if (msg.length > 0) { %>
                                        <% if (msg[0].readed == 0) { %>
                                        <i class="fa-solid fa-circle text-danger me-3 mt-2"></i>
                                        <% } %>
                                        <% } %>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <% users.forEach((user) => { %>
        <div class=" chatbox" id="chatbox-<%= user.user_id %>">
            <!-- หัวแชท -->
            <div class="d-flex shadow-6-soft border-bottom chat-title">
                <input type="text" class="room" name="id" value="<%= user.user_id %>" hidden>
                <div class="rounded-circle overflow-hidden border" style="width: 40px; height: 40px; margin: 10px;">
                    <img src="<%= user.picture %>" alt="user-profile" draggable="false" class="w-100 h-100">
                </div>
                <span class="fs-5 align-self-center"><%= user.username %></span>
            </div>

            <!-- กล่องข้อความ -->
            <div class="message pb-2" id="message-<%= user.user_id %>" style="height: 85vh;">

            </div>

            <!-- input -->
            <form action="" onsubmit="event.preventDefault(); sendMessage(`<%= user.user_id %>`);">
                <div class="input-message-wrap">
                    <div class="text-message d-flex">
                        <input class="input-message shadow-6-strong" id="input-message-<%= user.user_id %>" type="text"
                            placeholder="พิมพ์ข้อความ.." name="message-text" maxlength="300">
                        <div class="d-flex chat-action">
                            <!-- <div class="upload-img">
                                <i class="fa-solid fa-image ms-1"></i>
                                <input type="file" name="option_img[]" onchange="previewImage(event, [0])"
                                    accept="image/png, image/jpeg" multiple />
                            </div> -->
                            <button class="send-ms" type="submit">
                                <i class="fa-sharp fa-solid fa-paper-plane" style="color: #425c8a;"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <% }) %>
    </div>
</body>

<!-- <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
    integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous">
</script> -->
<script>
    const adminWhoLogind = '<%= session.user_id %>';
</script>
<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();

    // var chatHistoryCache = {};

    $(document).ready(function () {
        $(document).on("click", ".user-box", function () {
            var userId = $(this).data("user");
            socket.emit('joinRoom', userId);
            $("#id").val(userId);
            $('.chatbox').hide();
            $(`#chatbox-${userId}`).show();
            $(`#userbox${userId} .nonti i`).remove()

            getChatHistory(userId);
            $.ajax({
                url: "/admin/chat-readed",
                method: "POST",
                data: {
                    id: userId
                },
                success: function (response) {

                },
                error: function (error) {
                    console.error("Error:", error);
                }
            });
            history.pushState(null, null, `/admin/chat/${userId}`);

            var ms = document.querySelector(`#message-${userId}`);
            ms.scrollTop = ms.scrollHeight;

            $('#chatmenu').load(location.href + " #chatmenu");
        });
    });

    function getChatHistory(userId) {
        $.ajax({
            url: "/admin/chat-history",
            method: "GET",
            data: {
                userId: userId
            },
            success: function (response) {
                // chatHistoryCache[userId] = response;
                displayChatHistory(response, userId);
                // console.log(response);
                // var chatbox = $(`#chatbox-${userId}`).is(":hidden");
                // if (chatbox == false) {
                //     console.log('เปิดแชท');
                //     socket.on('newMessage', (message) => {
                //         console.log(`Admin Received message: ${message.message}`);
                //         getMessage(message.message, message.sender);
                //     });
                // }
            },
            error: function (error) {
                console.error("Error fetching chat history:", error);
            }
        });
    }

    function displayChatHistory(history, userId) {
        var messageContainer = $(`.message`);
        messageContainer.empty();

        history.forEach(function (message) {
            var messageBox = $("<div>").addClass("message-wrap");
            var messageText = $("<div>").text(message.message);

            if (message.sender_id === 'admin') {
                messageText.addClass("message-box-right");
            } else {
                messageText.addClass("message-box-left");
            }
            messageBox.append(messageText);
            messageContainer.append(messageBox);
        });
    }

    // Send a message to the admin
    function sendMessage(userId) {
        const messageInput = document.querySelector(`#input-message-${userId}`);
        const message = messageInput.value;
        // Emit an event to send the message to the admin
        socket.emit('sendMessage', {
            sender: 'admin',
            receiver: userId,
            message: message,
            room: userId
        });
        // Clear the message input
        messageInput.value = '';
        // Append the sent message to the chat box
        const messageBox = document.createElement('div');
        messageBox.classList.add('message-wrap');
        messageBox.innerHTML = `
        <div class="message-box-right border">
          <span>${message}</span>
        </div>
      `;
        document.querySelector(`#message-${userId}`).appendChild(messageBox);
        var objDiv = document.querySelector(`#message-${userId}`)
        objDiv.scrollTop = objDiv.scrollHeight;

        if ($(`#chatbox-${userId}`).is(':visible')) {
            $.ajax({
                url: "/admin/chat-readed",
                method: "POST",
                data: {
                    id: userId
                },
                success: function (response) {

                },
                error: function (error) {
                    console.error("Error:", error);
                }
            });
        }
        $('#getUserChatBox').load(location.href + " #getUserChatBox");
    }


    function getMessage(message, sender, room) {
        console.log('getMessage called');
        console.log('Room:', room);

        if ($(`#chatbox-${room}`).is(':hidden')) {
            $(`#userbox${room} .nonti`).empty().append('<i class="fa-solid fa-circle text-danger me-3 mt-2"></i>')
        } else if ($(`#chatbox-${room}`).is(':visible')) {
            $.ajax({
                url: "/admin/chat-readed",
                method: "POST",
                data: {
                    id: room
                },
                success: function (response) {

                },
                error: function (error) {
                    console.error("Error:", error);
                }
            });
        }
        $(`#current-ms-${room}`).empty().text(message)

        const messageBox = document.createElement('div');
        messageBox.classList.add('message-wrap');
        const messageText = document.createElement('div');
        if (sender === 'admin') {
            messageText.classList.add('message-box-right');
        } else {
            messageText.classList.add('message-box-left');
        }
        messageText.innerHTML = `<span>${message}</span>`;
        messageBox.appendChild(messageText);
        $(`#message-${room}`).append(messageBox);
        var objDiv = document.querySelector(`#message-${room}`);
        objDiv.scrollTop = objDiv.scrollHeight;
    }

    function readed(params) {

    }

    socket.on('adminMessage', (message) => {
        console.log(`Received message: ${message.message}`);
        $('#getUserChatBox').load(location.href + " #getUserChatBox");
        getMessage(message.message, message.sender, message.room);
    });

    function updateChat(message, room) {
        const current_ms = $('#current-ms')
    }


    $(document).ready(function () {
        $("#searchChat").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $('#userlist .user-box').filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
    });
</script>