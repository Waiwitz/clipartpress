<%- include('../partials/header') %>
<style>
    .dd-selected-image,
    .dd-option-image {
        margin: 0.85em 0.5em;
        width: 35px !important;
        height: 35px !important;
    }

    .dd-selected,
    .dd-option {
        padding: 0;
        height: 60px;
    }

    .dd-option-text {
        line-height: 0;
    }

    label.dd-selected-text {
        line-height: 62px !important;
    }

    .nav-space {
        height: 60px;
    }

    .navbar-brand img {
        width: 60px;
    }
</style>

<body>
    <div class="container-lg mt-5 mb-5 p-auto">
        <div>
            <h2>ออเดอร์ #<%= orders[0].order_id %></h2>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">หน้าแรก</a></li>
                <li class="breadcrumb-item"><a href="/myorder">รายการที่สั่ง</a></li>
                <li class="breadcrumb-item active" aria-current="page">ออเดอร์ #<%= orders[0].order_id %></li>
            </ol>
        </div>

        <div class="d-flex">
            <div class="col-8">
                <div class="card">
                    <div class=" m-3">
                        <div class="card-header mb-3 d-flex justify-content-between">
                            <h4 class="m-0 me-2 d-inline">รายละเอียดรายการ</h4>
                            <% if (orders[0].order_status === 'waitpay' || orders[0].order_status === 'pending') { %>
                            <button class="btn btn-danger" data-bs-toggle="modal"
                                data-bs-target="#cancelOrder">ยกเลิกออเดอร์</button>
                            <% } %>
                        </div>
                        <div class="px-3">
                            <% let sumprice = 0; %>
                            <% let couponDiscount = 0; %>
                            <% let shipmentprice = orders[0].shipment_price; %>
                            <% orders[0].order_detail.forEach((order, index) => { %>
                            <div class="row my-2 py-2">
                                <div class="col-3 h-100">
                                    <div class="myorder-product-img">
                                        <img src="<%= order.picture %>" alt="" class="imageFitBox">
                                    </div>
                                </div>
                                <div class="col-5">
                                    <h4><%= order.productName %></h4>
                                    <div class="collapse-horizontal">
                                        <span class="mb-2"> ขนาดของชิ้นงาน : <%= order.size %></span><br>
                                        <% order.options.forEach((option) => { %>
                                        <span class="mb-2"> <%= option.option_type %> :
                                            <%= option.option_name %></span><br>
                                        <% }) %>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <h5>จำนวน</h5>
                                    <p><%= order.quantity %></p>
                                </div>
                                <div class="col-2">
                                    <h5>ราคา</h5>
                                    <p><%= money.format(order.price) %></p>
                                </div>
                            </div>
                            <% sumprice += order.price %>
                            <% }) %>
                            <% let vat = sumprice * 7 / 100; %>
                        </div>
                    </div>
                    <div class="m-3 col">
                        <div class="card-header mb-3">
                            <h4 class="m-0">ที่อยู่จัดส่ง</h4>
                        </div>
                        <div class="mx-3">
                            <% shipment.forEach((addr) => { %>
                            <b id="ad-name"><%= addr.name %></b> <br>
                            <span class="card-text" id="ad-info">
                                <%= addr.address %> <%= addr.province %> <%= addr.postcode %>
                            </span> <br>
                            <span id="ad-tel"><%= addr.telephone%></span>
                            <% }) %>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="sticky-top" id="paymentSection">
                    <div class="card">
                        <% if (orders[0].discount != null) { %>
                        <% couponDiscount = orders[0].discount; %>
                        <% } %>
                        <% if (orders[0].order_status === 'waitpay') { %>
                        <div class="card-header d-flex justify-content-between">
                            <h4 class="mt-2">ชำระเงิน</h4>
                            <button class="btn btn-small btn-link" data-bs-toggle="modal"
                                data-bs-target="#selectPayment">เปลี่ยน</button>
                        </div>
                        <div class="card-body">
                            <div id="showpayment" class="text-center">
                                <% if (orders[0].method_type === 0) { %>
                                <div class="border mb-3">
                                    <img src="/assets/img/prompt-pay.png" alt="" class="w-75 px-4 mt-4">
                                    <img src="<%= qrcode %>" alt="" class="w-75 h-100 object-cover" draggable="false">
                                </div>
                                <% } else if (orders[0].method_type === 1) {%>
                                <div class="border mb-3 pt-3">
                                    <img src="/assets/img/logoBank/<%= selectmethod[0].method_name %>.png" alt=""
                                        class="w-25">
                                    <div class="mt-3">
                                        <b class="fs-5"><%= selectmethod[0].number %></b>
                                        <p><%= selectmethod[0].name %></p>
                                    </div>
                                </div>
                                <% } %>
                            </div>
                            <div class="text-center mb-3">
                                <h5 class="alert-warning p-3">ยอดที่ต้องชำระ
                                    <%= money.format((sumprice + shipmentprice + vat) - couponDiscount) %></h5>
                                <p>หลังจากสแกนและโอนเงินแล้ว กรุณาอัปโหลดหลักฐานสลิปการโอนและกดยืนยันการชำระ </p>
                                <p>ออเดอร์จะถูกยกเลิกหากไม่ชำระเงินภายใน 24 ชั่วโมงหลังจากสั่งซื้อ</p>
                            </div>
                            <form action="/uploadslip/<%= orders[0].order_id %>" id="uploadslip"
                                enctype="multipart/form-data" class="needs-validation" method="post" novalidate>
                                <div class="mb-3">
                                    <label class="form-label" for="dateTf">วันเวลาที่ทำรายการ<span
                                            class="text-danger ms-1">*</span></label>
                                    <input type="datetime-local" id="dateTf" name="dateTf" class="form-control"
                                        required />
                                    <div class="invalid-feedback">
                                        กรุณาระบุวันที่โอน
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">แนบหลักฐานการชำระเงิน <span
                                            class="text-danger ms-1">*</span></label>
                                    <input class="form-control d-inline-block d-inline" name="slip" id="slip"
                                        type="file" accept="image/png, image/jpeg" required>
                                    <div class="invalid-feedback">
                                        กรุณาแนบหลักฐานการชำระเงิน
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary fs-6 w-100 mt-5">ยืนยันการชำระ</button>
                            </form>
                        </div>
                        <% } else {%>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <!-- รอเช็คเงิน กำลังผลิต กำลังจัดส่ง ส่งเสร็จ -->
                                <div class="d-flex justify-content-center mb-3">
                                    <div
                                        class="rounded-circle order-status <%= orders[0].order_status === 'pending' || orders[0].order_status === 'produce' || orders[0].order_status === 'shipping' || orders[0].order_status === 'success' ? 'order-border-success' : ''%>">
                                        <i
                                            class="fa-regular fa-clock me-1 <%= orders[0].order_status === 'pending' || orders[0].order_status === 'produce' || orders[0].order_status === 'shipping' || orders[0].order_status === 'success' ? 'order-icon-success' : ''%>"></i>
                                        <div
                                            class="order-line-process <%= orders[0].order_status === 'produce' || orders[0].order_status === 'shipping' || orders[0].order_status === 'success' ? 'order-border-success' : ''%>">
                                        </div>
                                    </div>
                                    <div
                                        class="rounded-circle order-status <%= orders[0].order_status === 'produce' || orders[0].order_status === 'shipping' || orders[0].order_status === 'success' ? 'order-border-success' : ''%>">
                                        <i
                                            class="fa-solid fa-gears <%= orders[0].order_status === 'produce' || orders[0].order_status === 'shipping' || orders[0].order_status === 'success' ? 'order-icon-success' : ''%>"></i>
                                        <div
                                            class="order-line-process <%= orders[0].order_status === 'shipping' || orders[0].order_status === 'success' ? 'order-border-success' : ''%>">
                                        </div>
                                    </div>
                                    <div
                                        class="rounded-circle order-status <%= orders[0].order_status === 'shipping' || orders[0].order_status === 'success' ? 'order-border-success' : ''%>">
                                        <i
                                            class="fa-solid fa-box me-1 <%= orders[0].order_status === 'shipping' || orders[0].order_status === 'success' ? 'order-icon-success' : ''%>"></i>
                                        <div
                                            class="order-line-process <%= orders[0].order_status === 'success' ? 'order-border-success' : ''%>">
                                        </div>
                                    </div>
                                    <div
                                        class="rounded-circle order-status <%= orders[0].order_status === 'success' ? 'order-border-success' : ''%>">
                                        <i
                                            class="fa-solid fa-truck-fast me-1 <%= orders[0].order_status === 'success' ? 'order-icon-success' : ''%>"></i>
                                    </div>
                                </div>

                                <% if (orders[0].order_status === 'pending') {%>
                                <h5 class="alert-warning p-3">รอตรวจสอบ</h5>
                                <p>โรงพิมพ์จะเริ่มผลิตทันที <br>หลังจากตรวจสอบการชำระเงินแล้ว</p>
                                <% } else if (orders[0].order_status === 'produce') {%>
                                <h5 class="alert-info  p-3">
                                    กำลังผลิต
                                </h5>
                                <% } else if (orders[0].order_status === 'shipping') {%>
                                <h5 class="alert-info p-3">
                                    กำลังจัดส่ง
                                </h5>
                                <span>เลขพัสดุ: </span>
                                <% } else if (orders[0].order_status === 'success') {%>
                                <h5 class="alert-success p-3">
                                    จัดส่งสำเร็จ
                                </h5>
                                <% } else if (orders[0].order_status === 'cancel') {%>
                                <h5 class="alert-danger p-3">
                                    ยกเลิก
                                </h5>
                                <% if (cancel.length > 0) { %>
                                     <p>เหตุผล : <%= cancel[0].reason %></p>
                                <% } %>
                                <% } %>
                            </div>
                        </div>
                        <% } %>
                    </div>
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="mb-2 mx-3">
                                <div class="my-2 d-flex justify-content-between">
                                    <span>ยอดรวมสินค้า (<%= orders[0].order_detail.length %> รายการ)</span>
                                    <span>
                                        <%= money.format(sumprice) %>
                                    </span>
                                </div>
                                <div class="my-2 d-flex justify-content-between">
                                    <span>ค่าส่ง</span>
                                    <span>
                                        <%= money.format(shipmentprice) %>
                                    </span>
                                </div>
                                <div class="my-2 d-flex justify-content-between">
                                    <span>VAT 7%</span>
                                    <span>
                                        <%= money.format(vat) %>
                                    </span>
                                </div>
                                <% if (orders[0].coupon_id != null) { %>
                                <div class="my-2 d-flex justify-content-between">
                                    <span>ส่วนลด</span>
                                    <span class="text-danger">
                                        -<%= money.format(couponDiscount) %>
                                    </span>
                                </div>
                                <% } %>
                                <div class="border-top pt-3 my-2 d-flex justify-content-between">
                                    <b>ยอดที่ต้องชำระ</b>
                                    <div class="d-flex">
                                        <span class="fw-bold me-2" id="totalPrice">
                                            <% let amount =  (sumprice + shipmentprice + vat) - couponDiscount %>
                                            <%= money.format(amount) %>
                                        </span>
                                        <span class="fw-bold" id="newPrice">
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="selectPayment" aria-labelledby="selectAddress" role="dialog" aria-hidden="true"
        tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เปลี่ยนวิธีชำระเงิน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-center flex-wrap">
                        <% for( let i = 0; i < payment_method.length; i++ ) { %>
                        <div class="form-select-payment m-2 p-3 border text-center overflow-hidden <%= selectmethod[0].payment_method_id == payment_method[i].payment_method_id ? 'active' : '' %>"
                            style="width: 230px;">
                            <div>
                                <div class="m-auto mb-2" style=" height: 60px;">
                                    <img src="/assets/img/logoBank/<%= payment_method[i].method_name %>.png" alt=""
                                        class="h-100">
                                </div>
                                <% const bankname = banklist.find(row => row.en == payment_method[i].method_name) %>
                                <% if (bankname) { %>
                                <h6>โอนเงินผ่าน<%= bankname.th %></h6>
                                <% } else { %>
                                <h6>โอนเงินผ่าน Qr-code พร้อมเพย์</h6>
                                <% } %>
                            </div>
                            <input class="payment-radio" type="radio" name="paymentid"
                                value="<%= payment_method[i].payment_method_id %>"
                                <%= selectmethod[0].payment_method_id == payment_method[i].payment_method_id ? 'checked' : '' %> />
                        </div>
                        <% } %>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" id="closeInsert" data-bs-dismiss="modal"
                        aria-label="Close">ยกเลิก</button>
                    <button type="submit" id="changePayment" class="btn btn-primary" data-bs-dismiss="modal">ยืนยัน</button>
                </div>
            </div>
        </div>
    </div>

    <% if (orders[0].order_status === 'waitpay' || orders[0].order_status === 'pending') { %>
    <div class="modal" id="cancelOrder" aria-labelledby="selectAddress" role="dialog" aria-hidden="true" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <i class="fas fa-triangle-exclamation alert-warning rounded-circle p-2 fs-4"></i>
                        <h5 class="modal-title d-inline">ยกเลิกออเดอร์</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/cancelorder/<%= orders[0].order_id %>" class="needs-validation" method="post" novalidate>
                    <div class="modal-body" id="cancel-modal-body">
                        <div class="mb-3">
                            <label class="form-label" for="reason">เหตุผลที่ยกเลิก<span
                                    class="text-danger ms-1">*</span></label>
                            <select class="form-select" name="reason" id="reason" required>
                                <option value="เปลี่ยนใจในการสั่งซื้อ">เปลี่ยนใจในการสั่งซื้อ</option>
                                <option value="ต้องการเปลี่ยนออฟชั่นสินค้า">ต้องการเปลี่ยนออฟชั่นสินค้า</option>
                                <option value="ต้องการเปลี่ยนที่อยู่จัดส่ง">ต้องการเปลี่ยนที่อยู่จัดส่ง</option>
                                <option value="other">อื่นๆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" id="closeInsert" data-bs-dismiss="modal"
                            aria-label="Close">ปิด</button>
                        <button type="submit" id="changePayment" class="btn btn-danger">ยกเลิกออเดอร์</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <% } %>

    <%- include('../partials/footer') %>
</body>

<script>
    document.querySelectorAll('.form-outline').forEach((formOutline) => {
        new mdb.Input(formOutline).init();
    });
    $('#paymentMethod').ddslick({
        width: '100%',
        height: 150,
        imagePosition: "left",
    });
    $('#paymentMethod .dd-selected-value').attr('name', 'paymentMethod')

    $(document).ready(function () {
        $('.form-select-payment').each(function () {
            $(this).on('click', function () {
                $('.form-select-payment').removeClass('active');
                $(this).addClass('active');
            })
        })

        let loading = `    <div class="backdrop">
        <div class="d-flex justify-content-center align-self-center">
            <div class="spinner-border text-light fs-1" role="status">
              <span class="visually-hidden"></span>
            </div>
          </div>
    </div>`

        $('#changePayment').click(function () {
            const paymentid = $('input[name="paymentid"]:checked').val();
            $.ajax({
                url: `/changepayment/<%= orders[0].order_id %>/${paymentid}`,
                type: 'POST',
                success: async function () {

                    let text;
                    $('body').append(loading)
                    setTimeout(() => {
                        $('#showpayment').load(location.href + " #showpayment");
                        $('.backdrop').remove();

                    }, 800);
                },
                error: function (xhr, status, error) {
                    console.error('Error deleting item:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'มีบางอย่างผิดพลาด...',
                        text: 'กรุณาลองเลือกใหม่ภายหลัง',
                    })
                }
            });
        });


        $('#uploadslip').submit(function (event) {
            var formData = new FormData($('#uploadslip')[0]);
            event.preventDefault();
            if (!this[0].checkValidity()) {
                event.stopPropagation();
            } else {
                // const formData = $(this).serialize();
                $(this).removeClass('was-validated')
                $('body').append(loading)
                $.ajax({
                    url: `/uploadslip/<%= orders[0].order_id %>/<%= amount %>/<%= orders[0].payment_method_id %>`,
                    type: 'POST',
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function () {
                        setTimeout(() => {
                            $('#paymentSection').load(location.href +
                                " #paymentSection");
                            $('.backdrop').remove();
                            Swal.fire({
                                icon: 'success',
                                title: 'อัปโหลดสลิปสำเร็จ',
                                text: 'โรงพิมพ์จะเริ่มผลิตทันทีหลังจากตรวจสอบการชำระเงินสำเร็จ',
                            })
                        }, 1000);
                    },
                    error: function (xhr, status, error) {
                        setTimeout(() => {
                            $('.backdrop').remove();
                            Swal.fire({
                                icon: 'error',
                                title: 'มีบางอย่างผิดพลาด...',
                                text: 'กรุณาลองใหม่ภายหลัง',
                            })
                        }, 1000);
                        console.error('Error :',
                            error);
                    }
                });
            }
        })


        $('#reason').change(function () {
            if ($(this).val() === 'other') {
                let input =
                    '<input type="text" id="otherreason" name="reason" class="form-control" placeholder="ใส่เหตุผลอื่นๆ" required/>'
                $('#reason').attr('name', '')
                $('#cancel-modal-body').append(input);
            } else {
                $('#otherreason').remove();
                $('#reason').attr('name', 'reason')
            }
        })
    })
</script>